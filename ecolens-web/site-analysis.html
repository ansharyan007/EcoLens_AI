<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Analysis - CarbonScope AI</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for carbon trend graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/site-analysis.css">
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside id="sidebar">
        <div class="logo">
            <i class="fas fa-leaf"></i>
            <div>
                <h2>CarbonScope AI</h2>
                <p>Carbon Monitor</p>
            </div>
        </div>

        <nav class="nav-links">
            <a href="dashboard.html" class="nav-link">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="map.html" class="nav-link">
                <i class="fas fa-map-marked-alt"></i>
                <span>Map Explorer</span>
            </a>
            <a href="leaderboard.html" class="nav-link">
                <i class="fas fa-trophy"></i>
                <span>Leaderboard</span>
            </a>
            <a href="profile.html" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </nav>

        <div class="user-info">
            <div class="avatar" id="userAvatar">DU</div>
            <div class="user-details">
                <p class="username" id="displayName">Demo User</p>
                <p class="points" id="userPoints">1,250 points</p>
            </div>
            <button onclick="logout()" class="logout-btn" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="site-content">
        <!-- Header -->
        <div class="site-header">
            <div class="header-left">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="site-title-section">
                    <h1 id="siteName">Loading...</h1>
                    <p id="siteLocation">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="locationText">Loading location...</span>
                    </p>
                </div>
            </div>
            <div class="header-actions">
                <button class="action-btn" onclick="shareSite()">
                    <i class="fas fa-share-alt"></i>
                    Share
                </button>
                <button class="action-btn" onclick="exportReport()">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">
                <i class="fas fa-info-circle"></i>
                Overview
            </button>
            <button class="tab-btn" onclick="openTimelapsePage()">
                <i class="fas fa-play-circle"></i>
                Time-Lapse
            </button>
            <button class="tab-btn" onclick="switchTab('reports')">
                <i class="fas fa-clipboard-list"></i>
                Reports
            </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-panel active">
                <!-- Metric Cards -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(34, 197, 94, 0.2);">
                            <i class="fas fa-industry" style="color: #22c55e;"></i>
                        </div>
                        <div class="metric-info">
                            <p class="metric-label">Facility Type</p>
                            <h3 class="metric-value" id="facilityType">-</h3>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(234, 179, 8, 0.2);">
                            <i class="fas fa-smog" style="color: #eab308;"></i>
                        </div>
                        <div class="metric-info">
                            <p class="metric-label">Carbon Estimate</p>
                            <h3 class="metric-value" id="carbonEstimate">-</h3>
                            <p class="metric-unit">tons/year</p>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(59, 130, 246, 0.2);">
                            <i class="fas fa-clipboard-check" style="color: #3b82f6;"></i>
                        </div>
                        <div class="metric-info">
                            <p class="metric-label">Total Reports</p>
                            <h3 class="metric-value" id="reportCount">-</h3>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon" style="background: rgba(239, 68, 68, 0.2);">
                            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                        </div>
                        <div class="metric-info">
                            <p class="metric-label">Status</p>
                            <h3 class="metric-value" id="violationStatus">-</h3>
                        </div>
                    </div>
                </div>

                <!-- Images Section -->
                <div class="images-section">
                    <div class="image-card" id="groundImageCard">
                        <h3><i class="fas fa-street-view"></i> Ground View</h3>
                        <div class="image-container">
                            <div class="loading-placeholder" id="groundLoading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading ground view...</p>
                            </div>
                            <img id="groundImage" src="" alt="Ground" style="display: none;">
                            <div class="image-overlay">
                                <button class="zoom-btn" onclick="zoomImage('ground')" title="View Fullscreen">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="image-card" id="satelliteImageCard">
                        <h3><i class="fas fa-satellite"></i> Satellite View</h3>
                        <div class="image-container">
                            <div class="loading-placeholder" id="satelliteLoading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading satellite view...</p>
                            </div>
                            <img id="satelliteImage" src="" alt="Satellite" style="display: none;">
                            <div class="image-overlay">
                                <button class="zoom-btn" onclick="zoomImage('satellite')" title="View Fullscreen">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Details Section -->
                <div class="details-section">
                    <h3>Site Details</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <i class="fas fa-map-pin"></i>
                            <div>
                                <p class="detail-label">Coordinates</p>
                                <p class="detail-value" id="coordinates">-</p>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-brain"></i>
                            <div>
                                <p class="detail-label">AI Confidence</p>
                                <p class="detail-value" id="aiConfidence">-</p>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <div>
                                <p class="detail-label">First Reported</p>
                                <p class="detail-value" id="firstReported">-</p>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <p class="detail-label">Contributors</p>
                                <p class="detail-value" id="contributors">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-primary" onclick="viewOnMap()">
                        <i class="fas fa-map"></i>
                        View on Map
                    </button>
                    <button class="btn-secondary" onclick="openTimelapsePage()">
                        <i class="fas fa-play"></i>
                        Generate Time-Lapse
                    </button>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-panel">
                <div class="reports-container">
                    <h2>Site Reports History</h2>
                    <div id="reportsList" class="reports-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading reports...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Fullscreen Modal for Zoomed Views -->
    <div id="fullscreenModal" class="fullscreen-modal">
        <button class="modal-close-btn" onclick="closeFullscreenModal()">
            <i class="fas fa-times"></i> Close
        </button>
        <div class="modal-content">
            <iframe id="fullscreenIframe" frameborder="0"></iframe>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Custom Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/site-analysis.js"></script>
    
    <script>
        // Function to open time-lapse page
        function openTimelapsePage() {
            // Get current site data from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const siteId = urlParams.get('id');
            
            // Store current site data in sessionStorage for the time-lapse page
            if (typeof currentSite !== 'undefined' && currentSite) {
                sessionStorage.setItem('timelapseData', JSON.stringify({
                    siteId: siteId,
                    siteName: currentSite.name || document.getElementById('siteName').textContent,
                    latitude: currentSite.latitude,
                    longitude: currentSite.longitude,
                    carbonEstimate: currentSite.carbonEstimate,
                    facilityType: currentSite.type
                }));
            }
            
            // Open time-lapse page
            window.location.href = `time-lapse-page.html${siteId ? '?siteId=' + siteId : ''}`;
        }
    </script>
</body>

</html>
